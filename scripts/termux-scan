#!/data/data/com.termux/files/usr/bin/bash

RES="300"
MODE="Color" # SANE expects "Color", "Gray", or "Lineart"
SCAN_EXTRA_ARGS=""
export BRIDGE_LOG_LEVEL=0

# Parse command line arguments
while [[ "$#" -gt 0 ]]; do
    case $1 in
        --res) RES="$2"; shift 2 ;;
        --mode) MODE="$2"; shift 2 ;;
        --scan-args) SCAN_EXTRA_ARGS="$2"; shift 2 ;;
        -l|--log-level) BRIDGE_LOG_LEVEL="$2"; shift 2 ;;
        -h|--help) 
            echo "Usage: termux-scan [options]"
            echo "Options:"
            echo "  --res        Set DPI resolution (Default: 300). Example: --res 600"
            echo "  --mode       Set color mode (Color, Gray, Lineart). Default: Color"
            echo "  --scan-args  Pass custom SANE flags. Example: --scan-args \"--source 'ADF'\""
            echo "  -l level     Set libusb log level (0-4, default 0)"
            exit 0
            ;;
        *) echo "Unknown parameter passed: $1"; exit 1 ;;
    esac
done

export SCAN_RES="$RES"
export SCAN_MODE="$MODE"
export SCAN_EXTRA_ARGS="$SCAN_EXTRA_ARGS"
export BRIDGE_LOG_LEVEL="$BRIDGE_LOG_LEVEL"

USB_PATH=$(termux-usb -l | grep -o "/dev/bus/usb/[0-9]*/[0-9]*" | head -n 1)

if [ -z "$USB_PATH" ]; then
    echo "Error: No USB device found. Please connect your scanner."
    exit 1
fi

echo "Found USB device at $USB_PATH. Requesting permission..."
termux-usb -r -e run_scanner.sh "$USB_PATH"
